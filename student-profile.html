<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Профиль студента | ProStart</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="./styles/reset.css">
    <link rel="stylesheet" href="./styles/main.css">
    <style>
        .student-profile-layout {
            padding: 40px 0;
            max-width: 900px;
            margin: 0 auto;
        }

        .student-profile-card {
            margin-bottom: 30px;
        }

        .student-profile__header {
            display: flex;
            gap: 30px;
            align-items: center;
            margin-bottom: 30px;
        }

        .student-profile__avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: #E2E8F0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .student-profile__info h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .student-profile__info p {
            color: var(--color-subtle-text);
            margin-bottom: 5px;
        }

        .portfolio-section {
            margin-top: 30px;
        }

        .portfolio-item {
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--color-primary);
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="container header__content">
            <a href="/" class="header__logo">ProStart</a>
            <nav class="header__nav" id="mainNav">
                <ul class="header__nav-list">
                    <li id="navCatalogItem"><a href="/catalog.html" class="header__nav-link">Биржа задач</a></li>
                    <li id="navMentorsItem"><a href="/mentors.html" class="header__nav-link">Менторы</a></li>
                    <li id="navProfileItem" style="display: none;"><a href="/profile.html" class="header__nav-link">Профиль</a></li>
                    <li id="navMessengerItem" style="display: none;"><a href="/messenger.html" class="header__nav-link">Мессенджер</a></li>
                </ul>
            </nav>
            <div class="header__auth-buttons" id="authButtons">
                <a id="loginBtn" href="/log-in.html" class="button button--secondary">Вход</a>
                <a id="signupBtn" href="/sign-up.html" class="button button--primary">Регистрация</a>
                <button id="logoutBtn" onclick="logoutUser()" class="button button--secondary" style="display: none;">Выйти</button>
            </div>
        </div>
    </header>

    <main class="container student-profile-layout">
        <button class="button button--secondary" style="margin-bottom: 20px;" onclick="window.history.back()">
            ← Назад
        </button>

        <div class="student-profile-card card" id="studentProfileCard">
            <div class="student-profile__header">
                <div class="student-profile__avatar" id="studentAvatar">
                    <img src="/assets/images/free-icon-hacker-924915.png" alt="" style="width: 60px;">
                </div>
                <div class="student-profile__info" style="flex-grow: 1;">
                    <h1 id="studentName">Загрузка...</h1>
                    <p id="studentEmail"></p>
                    <p style="font-weight: 600; color: var(--color-primary);">Студент</p>
                    <p id="studentLevel" style="font-weight: 600; color: var(--color-primary); margin-top: 5px;"></p>
                    <div id="chatButtonContainer" style="margin-top: 15px;"></div>
                </div>
            </div>

            <div class="portfolio-section">
                <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 20px;">Портфолио</h2>
                <div id="portfolioList">
                    <p style="color: var(--color-subtle-text);">Загрузка...</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container footer__content">
            <div class="footer__logo">ProStart</div>
            <div class="footer__links">
                <a href="/catalog.html">Задачи</a>
                <a href="#">Контакты</a>
                <a href="#">Политика</a>
            </div>
            <p class="footer__copy">&copy; 2025 ProStart. Все права защищены.</p>
        </div>
    </footer>

    <script src="./scripts/db.js"></script>
    <script src="./scripts/auth.js"></script>
    <script src="./scripts/profile.js"></script>
    <script>
        function renderStudentProfile() {
            const studentId = parseInt(localStorage.getItem('prostartViewStudentId'));
            if (!studentId) {
                alert('Студент не найден.');
                window.location.href = '/catalog.html';
                return;
            }

            const users = getDBData(DB_KEYS.USERS) || [];
            const student = users.find(u => u.id === studentId && u.role === 'student');
            const currentUser = getCurrentUser();

            if (!student) {
                alert('Студент не найден.');
                window.location.href = '/catalog.html';
                return;
            }

            // Заполняем данные студента
            document.getElementById('studentName').textContent = student.name;
            document.getElementById('studentEmail').textContent = student.email;
            
            // Отображаем уровень студента
            const studentLevel = document.getElementById('studentLevel');
            if (studentLevel && typeof calculateStudentLevel === 'function') {
                const level = calculateStudentLevel(student);
                studentLevel.textContent = `Уровень: ${level}`;
            }

            // Добавляем кнопку чата для ментора
            const chatButtonContainer = document.getElementById('chatButtonContainer');
            if (currentUser && currentUser.role === 'mentor') {
                chatButtonContainer.innerHTML = `
                    <button class="button button--primary" onclick="startChatWithStudent(${studentId})">
                        Написать студенту
                    </button>
                `;
            } else {
                chatButtonContainer.innerHTML = '';
            }

            // Отображаем портфолио
            const portfolioList = document.getElementById('portfolioList');
            const portfolio = student.portfolio && Array.isArray(student.portfolio) ? student.portfolio : [];

            if (portfolio.length === 0) {
                portfolioList.innerHTML = '<p style="color: var(--color-subtle-text);">Портфолио пока пусто.</p>';
            } else {
                portfolioList.innerHTML = portfolio.map((item, index) => `
                    <div class="portfolio-item card">
                        <h3 style="font-weight: 600; margin-bottom: 10px;">${item.title || `Проект ${index + 1}`}</h3>
                        ${item.description ? `<p style="color: var(--color-subtle-text); margin-bottom: 10px;">${item.description}</p>` : ''}
                        ${item.link ? `<a href="${item.link}" target="_blank" class="button button--secondary" style="font-size: 0.9rem;">Посмотреть проект</a>` : ''}
                    </div>
                `).join('');
            }
        }

        function startChatWithStudent(studentId) {
            if (!isAuthenticated()) {
                alert('Для начала чата необходимо авторизоваться.');
                window.location.href = '/log-in.html';
                return;
            }

            const currentUser = getCurrentUser();
            if (currentUser.role !== 'mentor') {
                alert('Только менторы могут начинать чат со студентами.');
                return;
            }

            localStorage.setItem('prostartCurrentChatStudent', studentId);
            window.location.href = '/messenger.html';
        }

        window.addEventListener('load', () => {
            renderStudentProfile();
        });
        window.startChatWithStudent = startChatWithStudent;
    </script>
</body>

</html>

